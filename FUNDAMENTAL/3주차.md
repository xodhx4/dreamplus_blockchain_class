## Chapter 5 

### Smart Contracts

#### 복습

- 비트코인을 특별하게 하는 것은 무엇인가?

  - 분산형 네트워크 개념

- 분산형 네트워크 특징

  1. 암호와 신원(공공키 및 개인키 암호화)
     - 개인에 대한 정보를 제공하지 않고 디지털 자산 소유권을 증명할 수 있다.

  2. 합의 프로토콜
  3. 블록체인
     - 편집이 불가능한 데이터 구조

- 분산형 네트워크의 장점

  - 비신용성 : 서로를 몰라도 합의를 이룰 수 있다.
  - 변할 수 없음

#### 스마트 계약

- 계약조건을 결정적인 프로그램 코드에 작성한다.
- 모든 계약 내용을 코드화하여 계약 상대방이 신뢰할 만한지 살펴볼 필요 없이 코드가 일을 하게 하는 것

### Ethereum

#### 이더리움

- 블록체인 스마트컨트랙트 플랫폼

- 분산된 컴퓨터로 스마트계약을 실행한다.

- 기본적으로 가상화폐지만 가장 핵심은 아니다

- 비트코인과 차이점

  | 비트코인                            | 이더리움                                                     |
  | ----------------------------------- | ------------------------------------------------------------ |
  | 거래시스템이기 때문에 간단하고 견고 | 스마트계약으로 더 복잡하고 더 많은 기능을 가지며 코인은 부차적 |
  | 블록 생성시간 10분                  | 블록생성시간 12초                                            |

- UTXO는 일종의 난이도로 비트코인에 사용되었으며 이중 지출 문제를 해결

##### 이더리움 계좌

1. EOA(외부 소유 계좌)
   - 기본계좌로 계좌 주소를 통해 이더를 전송
2. Contract Account
   - 스마트 계약을 위한 계좌

##### 이더리움 계약 목적

1. 데이터 저장, 유지
2. 계약 및 비 신뢰 당사자들의 관계를 관리
3. 계약을 위한 함수를 제공
4. 복잡한 인증

### EVM(Ethereum Virtual Machine)

- solidity 계약 코드가 있다면 Solidity Compiler를 통해 어셈플리와 비슷한 EVM Code로 변형되게 된다.
- EVM 코드를 실행하기 위해서 컴퓨터에 EVM을 사용

##### 문제점

악의적인 코드를(무한 루프 등)을 강제로 다른 사람의 컴퓨터에 돌게할 수 없다.

##### 이더리움 solution

- Gas
  - Gas는 이더를 사용하면 지급되며, 함수 계약을 불러올 때만다 Gas를 사용한다.
  - startags는 스마트계약에 사용할 수 있는 최대 값
  - gasprice : 이더에서 가스로 전환되는 수수료
- 가스를 넣으면 스마트계약이 실행되고 사용하지 않으면 환급된다. 
- DDoS에 사용시 돈을 돌려받지 못한다.

#### 이더리움 네트워크 state

- 글로벌 이더리움 상태
  - 모든 주소, 계좌 , 이더 보유량
  - 데이터 유형, 모든 종류의 계약
  - 모든 정보를 가져다가 새로운 블록 상태로 출력

#### 이더리움 결론

- 계산에 효율적으로 설계되지는 않음
  -->비신뢰적 실행과 결과에 대한 합의를 위함
- 계약은 많이 복제되어 노드들을 돌아다니기 때문에 비싸다. 따라서 블록체인을 만들기 위한 인센티브가 필요

### Use Case

##### 4.1 Basic Use

- 비트코인처럼도 사용될 수 있다.
- 분산형 시스템으로 사용할 수 있다.
  - DDoS 같은 공격에 sof가 아니기 때문에 유용할 수 있다.
- Proof of Exsistence
  - 해쉬만을 블록체인에 남김으로써, 그 내용을 공개하지 않더라도, 존재하는지를 증명할 수 있다.

##### 4.2 Advanced Use Case

- 분산된 땅문서
  - 강력한 중앙 인프라가 없을 때 대체하여 사용할 수 있다.
  - 이전이 쉽다.
- 분산된 예측 시장
  - 대중의 정보를 이용하여 예측을 할 수 있게 한다.
  - ex) 
    - 2020년 미 대통령을 예측하는 것
    - 보험에 역시 이용할 수 있다.
    - 버그 바운티에 사용
  - 단점
    - 실제 결과를 확인하는 오라클이 정말 정직하게 잘 작동하는지 알 수 없다.
- 공급체인
  - 단점 : ID와 실물을 연결할 방법이 없다.
  - **정보의 진입 지점이 정직하다고 믿어야 한다.**
- 분산형 익명 그룹(Decentralized Autonomous Organization, DAO)

### 5. Generalization

##### 언제 블록체인을 사용할까?

- 공유 데이터베이스가 존재하는가?
  - 아니면 일반 저장소
- 공유 데이터베이스에 작성하는 사람이 여러명인가?
  - 아니명 중앙 저장소
- 다양한 객체가 서로를 불신하고 있는가?
  - 아니면 중앙저장소의 다양한 복제
- 신뢰할만한 중개인이 위험으르 감추고 있는가?
  - 아니면 신뢰할만한 제3자를 사용해라
- 거래간에 상호작용이 존재하는가?
  - 아니면 마스터-슬래이브 DB를 사용

##### 블록체인 기술의 한계

- 외부 데이터를 블록체인에 비 신뢰적으로 가져오는 방법이 없다.
  --> 오라클을 신뢰해야 함
- SGX, ARM과 같은 신뢰할만한 환경을 사용해야 한다.
- on-chain 지급을 강제할 방법이 없다.
- 효율성 등 다른 중요한 요소를 잃는다.

## Chapter 6

### POOL STRATECIES

- 보상방식
  - 지급대비 분배방식
  - 비례량
- Pool Hopping [참고자료](https://bitcoin.stackexchange.com/questions/5072/what-is-pool-hopping)
  - pool은 평균적으로 적정한 값을 지불하게 하는데, pool이 높은 값을 지불할 상태일 때에만 채굴하는 것
  - 예시
    - Proportional pool일 때 블록이 막 만들어졌을 때, 즉 reword가 높을 때 짧게 마이닝한다.
- 잠식 풀(cannibalizing pools)
  - 해시 파워를 서로 다른 풀에 공급
  - 가치를 부여하지 않고 더 많은 보상을 얻음
  - 공격여부를 결정하는 공격 전략으로 진행 가능
  - 죄수의 딜레마와 같이 서로의 풀을 공격했을 때 내쉬 균형은 서로 다른 풀을 공격할 때 얻게된다. 하지만 이렇게 될 시 모든 사용자가 적게 얻게 되는 문제가 있다. 

### FORKING & DOUBLE SPENDING

#### 이중지출 문제(Double Spending)

- 거래 구조에 따라 이중지출이 가능할 수도 있다.

- Race attack

  1. 지불하는 TX를 제공
  2. 확인 후 상품을 전달
  3. 실제로는 다른 네트워크에 먼저 다른 TX를 제공했음
  4. 나머지 네트워크에서 다른 TX를 네트워크에 추가
  5. 다른 TX를 블록에 기록되게 하기 위해 RBF(수수료 대제)를 진행하는 것도 가능

  - 이를 해결 하기 위해서는 TX 뿐만 아니라 컴펌도 확인해야 한다.
  - 실제 컨펌을 하더라도 많은 네트워크 파워를 가지고 있을 떄 다른 TX를 이기도록 할 수 있다. (51% 공격)
  - 따라서 공격자의 네트워크 해쉬파워에 따라 거래의 신뢰성이 바뀐다.

- 막기 위한 방법

  - 합의를 제외하고는 2블록 컨펌 이후에는 바꾸지 않기

### CENSORSHIP

#### 처벌적 Fork-to-Fork

- 검열을 하기 위해 51%의 해쉬파워를 가진 검열자가 특정 인물의 거래를 블록에 포함시키지 않는 것

#### 페더 포킹(Feather Forking)

- 51%가 되지 않더라도 검열하고자 하는 block의 인센티브를 높여 거래를 방해하는 것
- 네트워크 파워가 20%일 때 두개의 블록을 컴펌하여 목표인의 블록을 고아로 만들 수 있을 확률은 4%
- 다른 채굴자들도 이 것을 알고 있을 때, 목표인의 블록이 고아가 될 것을 고려하기 때문에 블록을 컨펌 시키기 위해 다른 채굴자들에게 높은 인센티브를 제공해야 한다.



### SELFISH MINING

- 마이너가 블록을 찾았을 때, 네트워크에 알리는 대신 몰래 보관하고 해당 블록 위에 새로운 블록을 찾는다.
- 블록을 보류시켜 다른 마이너의 계산 능력을 낭비하게 만든다.
- 상황
  - 두 번째 비밀 블록을 찾았을 때, 다른 네트워크가 새로운 블록을 찾았다면
    - 비밀블록을 공개해 가장 긴 체인을 바꿔 다른 네트워크의 블록을 고아로 만든다.
  - 두 번째 비밀 블록을 찾기전에, 다른 네트워크가 새로운 블록을 찾았다면
    - 정직한 블록과 경쟁해야 한다. 최대한 많은 사람에게 자신의 블록을 사용하게 해야한다.
    - 25%의 경우도 많은 이득을 얻을 수 있으며, 33%의 경우 정직한 경쟁자를 항상 이긴다.

### DEFENSES

- 이기적 채굴은 25%, 33%의 파워를 얻기 힘들기 때문에 현실적으로 힘들다.
- 방어 방법

1. 더미 서명

   - 목격자 서명을 추가해서 채굴을 진행하기 전에 특정 수의 목격자 서명이 존재해야 한다. 이를 통해 비밀 블록은 목격자 서명이 포함되지 않기 때문에 무효가 된다.

   - 방어가 구현될려면 비트코인의 하드포크가 필요하다.

2. 포크 처벌

   - 포크를 시도하는 참여자를 처벌
   - 이기적 채굴자와 정직한 채굴자 모두 보상을 받지 못하며, 포크가 있다고 증명한 목격자가 절반의 보상을 받을 수 있다.
   - 선의의 피해자가 생길 수 있다.
   - 하드포크가 필요하다. 

3. 특정 시간 안에 생성된 블록 중에 랜덤으로 블록을 선택한다.

   - 네트워크 합의의 잠재적 지연이 발생

4. 위조 블가능 시간 스탬프

   - 중앙 기구가 60초마다 시간 stamp를 발생
   - 블록 작업을 진행할 때 최신 stamp를 추가해야 한다.
   - 120초 이내 기록된 경쟁 블록이 있을 시 time stamp를 많이 가지고 있는 블록을 선택함으로써, 비밀 블록을 막을 수 있다.
   - 60초마다 시간 스탬프를 만들기 위한 중앙화된 기관이 필요하기 때문에 탈중앙화에 위배된다.

5. weighted FRP

   - 앞서는 블록 전파 경쟁에 대한 방어였다면, 이건 긴 비밀체인 생성을 방어하는 것
   - 높이 정책이 아닌 무게 포크 정책을 사용
   - 부모 블록이 등록된 이후 일정 시간 내에 생성된 경쟁 블록을 삼초 블록이라고 한다.
   - 삼촌 해쉬를 다음 블록에 포함되게 한다.

   - 한계
     - 비트코인의 동시성을 가정. 그러나 비트코인은 비동시성
     - 실제 요소를 무시하며, 자연 포크의 경우를 고려하지 않는다.
